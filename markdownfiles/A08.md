## Shell脚本编程

### 管道和过滤器(Pipes and Filters)

**学习目标**
1. 学习如何连接多个命令
2. 如何利用shell提示运行多命令
3. 学习利用管道和过滤器

#### 1.连接指令

> 运算符;

Linux shell允许我们使用符号;来进行多命令处理，其语法如下：
```
commond1;commond2;commond3
```
或者
```
{ commond1; commond2 }
```

> 运算符＆

&符号称为作业控制符，可以将任务或命令放在后台运行。作业控制，指控制当前正在运行的进程的行为，也称为进程控制。其常用命令有：
|命令或快捷键|功能说明|
|:---:|:---|
|commond &|将命令放在后台运行|
|Ctrl+d|终止一个正在前台运行的进程(含有正常含义)|
|Ctrl+c|终止一个正在前台运行的进程(含有强行含义)|
|Ctrl+z|挂起一个正在前台运行的进程|
|jobs|显示后台作业和被挂起的进程|
|bg|重新启动一个挂起的作业，并在后台运行|
|fg|把一个在后台运行的作业放到前台运行|

进程(Process)是一个程序在其自身的虚拟地址空间中的一次执行活动。Linux中的进程，每个进程有一个识别好，PID(Process ID)。系统启动后的第一个进程是init，PID是1．init是唯一一个由系统内核直接运行的进程。新的进程可以有系统调用fork产生，从一个旧进程中分出一个新进程来，旧进程是新进程的付进程，新进程是产生他的旧进程的子进程，除了init之外，每一个进程都有父进程。

系统启动后，init进程会创建login进程等待用户登录，当用户登录系统后，login进程就会为用户启动shell进程，此后用户运行的进程都是有shell衍生出来的。

进程启动方式：
1. 手动启动：由用户输入命令直接启动一个进程，分为前台启动（直接输入命令）和后台启动（在命令后使用&符号）。
2. 调度启动：事先设置，根据用户要求让系统自动启动。

> 操作符|

Shell管道可以将程序的输出和输入连接在一起，其操作符为|。其语法如下：
```
commond1 | commond2
cmd1 | cmd2 | cmd3
```
![管道操作](./image/Shell-pipes.png)

值得注意的是，管道操作符|可以与输入重定向符<以及输出重定向符>混合使用，以提高程序的可读性和可操作性。

总结如下：

|运算符|语法|说明|举例|
|:------:|:------|:-------|:-------|
|;|commond1; commond2|按顺序执行|date;pwd|
|&|commond arg &|在后台subshell中执行指令，完成后返回结束状态。|find / -iname "*.pdf" > /tmp/out.txt &|
|&&|commond1 && commond2|当指令1运行结束状态返回为0时，即指令1正常运行；此时指令2才会被执行，否则不执行。|[ ! -d /backup ] && mkdir -p /backup|
|&#124;&#124;|commond1 &#124;&#124; commond2|当指令1运行结束状态返回为非0时，即指令1非正常运行；此时指令2才会被执行，否则不执行。|tar cvf /dev/st0 /home &#124;&#124; mail -s 'Backup failed' you@example.com </dev/null|
|&#124;|commond1 &#124; commond2|Linux shell管道符号，即将指令1的标准输出作为指令2的标准输入。|ps aux &#124; grep httd|

#### 2.过滤器

在Linux Shell中，如果一个Linux指令可以使用标准输入(stdin)接受数据，并通过标准输出(stdout)输出结果，均可以看做是一个过滤器(Filter)。通常情况下，过滤器和管道配合使用。其语法如下：

```
commond1 | commond2
commond2 file.txt | commond2
commond1 args < input.txt | commond2
```
其中，commond2为过滤器命令。

举例说明：
```
＃ grep命令是Linux主要的过滤器指令
cut -d: -f1 /etc/passwd | sort | uniq | grep Vivek
ps aux | grep php-cgi
```

#### 常用的过滤器指令
- awk

awk是一种编程语言，用于在Linux/Unix下对文本和数据进行处理。数据可以来自标准输入(stdin)、一个或多个文件，或其他命令的输出。

- cut

cut用来显示行中的指定部分，删除文件中指定字段，经常用来显示文件的内容。cut命令有两项功能：1)显示文件内容，即依次读取有参数file所指的文件，将文件内容输出到标准输出上；2)连接两个或多个文件，例如`cut f1 f2 > f3`，即是把文件f1和文件f2的内容合并起来，输出重定向至文件f3。

**指令说明**：cut(选项)(参数)

 * 选项

 > -b:仅显示行中指定直接范围的内容  
 > -c:仅显示行中指定范围的字符  
 > -d:指定字段的分隔符，默认的字段分隔符是"TAB"  
 > -f:显示指定字段的内容  
 > -n:与-b连用，不分割多字节字符

 * 参数
 > 文件：指定要进行内容过滤的文件

- grep



- gzip
- head

head命令用于显示文件的开头内容，在默认情况下显示文件的头10行内容。

**指令说明**:head(选项)(参数)

  * 选项

  > -n<num>:指定显示头部内容的行数  
  > -c<字符数>:指定显示头部内容的字符数  
  > -v:总是显示文件名的头信息  
  > -q:不显示文件名的头信息  

  * 参数

  > 文件列表：指定显示头部内容的文件列表

- paste
- sed
- sort
- split
- strings
- tac
- tail

tail命令用于显示文件中的尾部内容，默认情况下在屏幕上显示指定文件的末尾10行。若指定的文件不止一个，则在显示的每个文件前面加一个文件名标题。

- tee

tee命令用于将数据重定向到文件，另一方面还可以重定向数据的副本作为后续命令的stdin。简单来说就是把数据重定向至文件和屏幕上。
存在缓存机制，每1024个字节将输出一次。若从管道接收输入数据，应该是缓冲区满，才将数据转存到指定文件中。若文件内容不到1024个字节，则接收完从标准输入设备读入的数据后，将刷新一次缓冲区，并转存数据到指定文件。

- tr

tr命令可以对来自标准输入的字符进行替换、压缩和删除，可以将一组字符变成另一组字符，经常用来编写优美的单行命令。

- uniq

uniq命令用于报告或忽略文件中的重复行，一般与sort命令结合使用。

**指令说明**:uniq(选项)(参数)

  * 选项

  > -c或--count:在每列旁边显示该行重复出现的次数  
  > -d或--repeated:仅显示重复出现的行列  
  > -f<栏位>或--skip-fields=<栏位>:忽略比较指定的栏位  
  > -s<字符位置>或--skip-chars=<字符位置>:忽略比较指定的符号  
  > -u或--uniqe:仅显示出一次的行列  
  > -w<字符位置>或--check-chars=<字符位置>:指定要比较的字符  

  * 参数

  > 输入文件：指定要去除的重复行文件。如果不指定此项，则从标准读取数据  
  > 输出文件：指定要去除重复行后的内容要写入的文件。如果不指定此项，则将内容显示到标准输出设备（显示终端）  

- wc

wc命令用来计算数字。利用wc指令我们可以计算文件的Byte数,字数或列数，若不指定文件名称，或是所给予的文件名为"-"，则wc指令会从标准输入设备读取数据。

**指令说明**:wc(选项)(参数)

  * 选项

  > -c或--bytes或--chars：只显示Bytes数  
  > -l或--lines：只显示列数  
  > -w或--words：只显示字数  

  * 参数

  > 文件：需要统计的文件列表
